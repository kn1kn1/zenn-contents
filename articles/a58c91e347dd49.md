---
title: "Apache Beamã®FileIOã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹"
emoji: "ğŸ“„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ApacheBeam", "Java", "Dataflow"]
published: true
---

# æ¦‚è¦

Beamã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§èª­ã¿å‡ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’å–ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸã®ã ãŒã€ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’æ›¸ã‹ãªã„ã¨ã„ã‘ãªã‹ã£ãŸã®ã§ãã®ãƒ¡ãƒ¢ã€‚


# æ›´æ–°æ—¥æ™‚ã‚’ä¸Šæ‰‹ãå–å¾—ã§ããªã„ä¾‹

ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€`FileIO.ReadableFile`ã‚’å–å¾—ã—ã€ãã“ã‹ã‚‰`MatchResult.Metadata`ã‚’å‚ç…§ã™ã‚Œã°è‰¯ã„ãŒã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ä¸Šæ‰‹ãã„ã‹ãªã„ã€‚

https://github.com/kn1kn1/beam-examples/blob/6de696825fda1669ab80b0d757a2c75c0e8532dc/readable-file/src/main/java/org/example/ReadableFileExampleNG.java#L20-L43

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`lastModifiedMillis: 0`, `lastModified: 1970-01-01T00:00:00.000Z`ã¨ãªã£ã¦ã—ã¾ã£ã¦ã„ãŸã€‚

```
*** name: kinglear.txt
*** lastModifiedMillis: 0
*** lastModified: 1970-01-01T00:00:00.000Z
*** sizeBytes: 157283
```


# å¯¾å¿œæ–¹æ³•

https://stackoverflow.com/questions/66845945/how-to-override-default-metadata-lastmodifiedmillis-of-apache-beams-fileio-wi/71669379#71669379 ã‚’å‚ç…§ã—ã¦ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ãŸã€‚

https://github.com/kn1kn1/beam-examples/blob/6de696825fda1669ab80b0d757a2c75c0e8532dc/readable-file/src/main/java/org/example/ReadableFileExample.java#L22-L52

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã€æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ããŸã€‚

```
*** name: kinglear.txt
*** lastModifiedMillis: 1472084114722
*** lastModified: 2016-08-25T00:15:14.722Z
*** sizeBytes: 157283
```

ä¸Šè¨˜ã‚’å‹•ä½œã•ã›ã‚‹ã«ã¯ã€Beamå´ã§ã®å¯¾å¿œãŒå¿…è¦ã§ã‚ã‚Šã€https://github.com/apache/beam/pull/15510 ã§å¯¾å¿œãŒå–ã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚

https://github.com/apache/beam/pull/15510 ã®ãƒãƒ¼ã‚¸ã¯`Oct 7, 2021`ã¨ã„ã†ã“ã¨ãªã®ã§ã€`Oct 13, 2021`ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸBeam 2.33.0ä»¥é™ãŒå¿…è¦ã§ã‚ã‚‹ã€‚

# ã¾ã¨ã‚

ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’æ­£ã—ãå–å¾—ã™ã‚‹ã«ã¯ä»¥ä¸‹ãŒå¿…è¦ã§ã‚ã‚‹ã€‚

- Beam 2.33.0ä»¥é™ã®Beam
- ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰
```
MetadataCoderV2 metadataCoder = MetadataCoderV2.of();
p.getCoderRegistry().registerCoderForClass(MatchResult.Metadata.class, metadataCoder);
p.getCoderRegistry().registerCoderForClass(FileIO.ReadableFile.class, ReadableFileCoder.of(metadataCoder));
```

ä¸Šè¨˜ã‚³ãƒ¼ãƒ‰ã¯ã€https://github.com/kn1kn1/beam-examples/tree/master/readable-file ã«æ ¼ç´ã—ãŸã€‚
