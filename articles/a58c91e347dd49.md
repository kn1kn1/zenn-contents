---
title: "Apache Beamã®FileIOã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹"
emoji: "ğŸ“„"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ApacheBeam", "Java", "Dataflow"]
published: true
---

# æ¦‚è¦

Beamã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§èª­ã¿å‡ºã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’å–ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ãŸã®ã ãŒã€ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’æ›¸ã‹ãªã„ã¨ã„ã‘ãªã‹ã£ãŸã®ã§ãã®ãƒ¡ãƒ¢ã€‚


# æ›´æ–°æ—¥æ™‚ã‚’ä¸Šæ‰‹ãå–å¾—ã§ããªã„ä¾‹

ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€`FileIO.ReadableFile`ã‚’å–å¾—ã—ã€ãã“ã‹ã‚‰`MatchResult.Metadata`ã‚’å‚ç…§ã™ã‚Œã°è‰¯ã„ãŒã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ä¸Šæ‰‹ãã„ã‹ãªã„ã€‚

```
PipelineOptions options = PipelineOptionsFactory.create();
Pipeline p = Pipeline.create(options);

p
        .apply(Create.of("gs://apache-beam-samples/shakespeare/kinglear.txt"))
        .apply(FileIO.matchAll())
        .apply(FileIO.readMatches())
        .apply(ParDo.of(
                new DoFn<FileIO.ReadableFile, String>() {
                    @ProcessElement
                    public void processElement(ProcessContext context, @Element FileIO.ReadableFile readableFile, OutputReceiver<String> r) throws IOException {
                        MatchResult.Metadata metadata = readableFile.getMetadata();
                        String name = metadata.resourceId().getFilename();
                        long lastModifiedMillis = metadata.lastModifiedMillis();
                        long sizeBytes = metadata.sizeBytes();
                        System.out.println("*** name: " + name);
                        System.out.println("*** lastModifiedMillis: " + lastModifiedMillis);
                        System.out.println("*** lastModified: " + Instant.ofEpochMilli(lastModifiedMillis));
                        System.out.println("*** sizeBytes: " + sizeBytes);
                        String content = readableFile.readFullyAsUTF8String();
                        r.output(content);
                    }
                }
        ))
```

ä¸Šè¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€`lastModifiedMillis: 0`, `lastModified: 1970-01-01T00:00:00.000Z`ã¨ãªã£ã¦ã—ã¾ã£ã¦ã„ãŸã€‚

```
*** name: kinglear.txt
*** lastModifiedMillis: 0
*** lastModified: 1970-01-01T00:00:00.000Z
*** sizeBytes: 157283
```


# å¯¾å¿œæ–¹æ³•

https://stackoverflow.com/questions/66845945/how-to-override-default-metadata-lastmodifiedmillis-of-apache-beams-fileio-wi/71669379#71669379 ã‚’å‚ç…§ã—ã¦ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ãŸã€‚

```
PipelineOptions options = PipelineOptionsFactory.create();
Pipeline p = Pipeline.create(options);

// WORKAROUND code for Metadata#lastModifiedMillis()
//  cf. https://github.com/apache/beam/pull/15510
//  cf. https://stackoverflow.com/questions/66845945/how-to-override-default-metadata-lastmodifiedmillis-of-apache-beams-fileio-wi/71669379#71669379
MetadataCoderV2 metadataCoder = MetadataCoderV2.of();
p.getCoderRegistry().registerCoderForClass(MatchResult.Metadata.class, metadataCoder);
p.getCoderRegistry().registerCoderForClass(FileIO.ReadableFile.class, ReadableFileCoder.of(metadataCoder));

p
        .apply(Create.of("gs://apache-beam-samples/shakespeare/kinglear.txt"))
        .apply(FileIO.matchAll())
        .apply(FileIO.readMatches())
        .apply(ParDo.of(
                new DoFn<FileIO.ReadableFile, String>() {
                    @ProcessElement
                    public void processElement(ProcessContext context, @Element FileIO.ReadableFile readableFile, OutputReceiver<String> r) throws IOException {
                        MatchResult.Metadata metadata = readableFile.getMetadata();
                        String name = metadata.resourceId().getFilename();
                        long lastModifiedMillis = metadata.lastModifiedMillis();
                        long sizeBytes = metadata.sizeBytes();
                        System.out.println("*** name: " + name);
                        System.out.println("*** lastModifiedMillis: " + lastModifiedMillis);
                        System.out.println("*** lastModified: " + Instant.ofEpochMilli(lastModifiedMillis));
                        System.out.println("*** sizeBytes: " + sizeBytes);
                        String content = readableFile.readFullyAsUTF8String();
                        r.output(content);
                    }
                }
        ))
```

ã“ã‚Œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ã€æ›´æ–°æ—¥æ™‚ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ããŸã€‚

```
*** name: kinglear.txt
*** lastModifiedMillis: 1472084114722
*** lastModified: 2016-08-25T00:15:14.722Z
*** sizeBytes: 157283
```

ä¸Šè¨˜ã‚’å‹•ä½œã•ã›ã‚‹ã«ã¯ã€Beamå´ã§ã®å¯¾å¿œãŒå¿…è¦ã§ã‚ã‚Šã€https://github.com/apache/beam/pull/15510 ã§å¯¾å¿œãŒå–ã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹ã€‚

https://github.com/apache/beam/pull/15510 ã®ãƒãƒ¼ã‚¸ã¯`Oct 7, 2021`ã¨ã„ã†ã“ã¨ãªã®ã§ã€`Oct 13, 2021`ã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸBeam 2.33.0ä»¥é™ãŒå¿…è¦ã§ã‚ã‚‹ã€‚

# ã¾ã¨ã‚

ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°æ—¥æ™‚ã‚’æ­£ã—ãå–å¾—ã™ã‚‹ã«ã¯ä»¥ä¸‹ãŒå¿…è¦ã§ã‚ã‚‹ã€‚

- Beam 2.33.0ä»¥é™ã®Beam
- ä»¥ä¸‹ã®ãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ©ã‚¦ãƒ³ãƒ‰ã‚³ãƒ¼ãƒ‰
```
MetadataCoderV2 metadataCoder = MetadataCoderV2.of();
p.getCoderRegistry().registerCoderForClass(MatchResult.Metadata.class, metadataCoder);
p.getCoderRegistry().registerCoderForClass(FileIO.ReadableFile.class, ReadableFileCoder.of(metadataCoder));
```
