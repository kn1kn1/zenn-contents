---
title: "Apache BeamのFileIOで、ファイルの更新日時を取得する"
emoji: "📄"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["ApacheBeam", "Java", "Dataflow"]
published: false
---

# 概要

Beamのパイプラインで読み出したファイルの更新日時を取るコードを書いたのだが、ワークアラウンドを書かないといけなかったのでそのメモ。


# 更新日時を上手く取得できない例

基本的には、`FileIO.ReadableFile`を取得し、そこから`MatchResult.Metadata`を取得すれば良いが、以下のコードでは上手くいかない。

```
PipelineOptions options = PipelineOptionsFactory.create();
Pipeline p = Pipeline.create(options);

p
        .apply(Create.of("gs://apache-beam-samples/shakespeare/kinglear.txt"))
        .apply(FileIO.matchAll())
        .apply(FileIO.readMatches())
        .apply(ParDo.of(
                new DoFn<FileIO.ReadableFile, String>() {
                    @ProcessElement
                    public void processElement(ProcessContext context, @Element FileIO.ReadableFile readableFile, OutputReceiver<String> r) throws IOException {
                        MatchResult.Metadata metadata = readableFile.getMetadata();
                        String name = metadata.resourceId().getFilename();
                        long lastModifiedMillis = metadata.lastModifiedMillis();
                        long sizeBytes = metadata.sizeBytes();
                        System.out.println("*** name: " + name);
                        System.out.println("*** lastModifiedMillis: " + lastModifiedMillis);
                        System.out.println("*** lastModified: " + Instant.ofEpochMilli(lastModifiedMillis));
                        System.out.println("*** sizeBytes: " + sizeBytes);
                        String content = readableFile.readFullyAsUTF8String();
                        r.output(content);
                    }
                }
        ))
```

上記のコードを実行すると、`lastModifiedMillis: 0`, `lastModified: 1970-01-01T00:00:00.000Z`となってしまっていた。

# 対応方法

https://stackoverflow.com/questions/66845945/how-to-override-default-metadata-lastmodifiedmillis-of-apache-beams-fileio-wi/71669379#71669379 を参照して以下のコードに変更した。

```
PipelineOptions options = PipelineOptionsFactory.create();
Pipeline p = Pipeline.create(options);

// WORKAROUND code for Metadata#lastModifiedMillis()
//  cf. https://github.com/apache/beam/pull/15510
//  cf. https://stackoverflow.com/questions/66845945/how-to-override-default-metadata-lastmodifiedmillis-of-apache-beams-fileio-wi/71669379#71669379
MetadataCoderV2 metadataCoder = MetadataCoderV2.of();
p.getCoderRegistry().registerCoderForClass(MatchResult.Metadata.class, metadataCoder);
p.getCoderRegistry().registerCoderForClass(FileIO.ReadableFile.class, ReadableFileCoder.of(metadataCoder));

p
        .apply(Create.of("gs://apache-beam-samples/shakespeare/kinglear.txt"))
        .apply(FileIO.matchAll())
        .apply(FileIO.readMatches())
        .apply(ParDo.of(
                new DoFn<FileIO.ReadableFile, String>() {
                    @ProcessElement
                    public void processElement(ProcessContext context, @Element FileIO.ReadableFile readableFile, OutputReceiver<String> r) throws IOException {
                        MatchResult.Metadata metadata = readableFile.getMetadata();
                        String name = metadata.resourceId().getFilename();
                        long lastModifiedMillis = metadata.lastModifiedMillis();
                        long sizeBytes = metadata.sizeBytes();
                        System.out.println("*** name: " + name);
                        System.out.println("*** lastModifiedMillis: " + lastModifiedMillis);
                        System.out.println("*** lastModified: " + Instant.ofEpochMilli(lastModifiedMillis));
                        System.out.println("*** sizeBytes: " + sizeBytes);
                        String content = readableFile.readFullyAsUTF8String();
                        r.output(content);
                    }
                }
        ))
```

これを実行すると、以下のように、有効な更新日時を取得することができた。

```
~/readable-file-example
$ mvn compile exec:java -Dexec.mainClass=org.example.ReadableFileExample
[INFO] Scanning for projects...

:
(snip)
:

11月 24, 2022 5:41:16 午前 org.apache.beam.sdk.io.FileIO$MatchAll$MatchFn process
情報: Matched 1 files for pattern gs://apache-beam-samples/shakespeare/kinglear.txt
*** name: kinglear.txt
*** lastModifiedMillis: 1472084114722
*** lastModified: 2016-08-25T00:15:14.722Z
*** sizeBytes: 157283
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  4.119 s
[INFO] Finished at: 2022-11-24T05:41:17+09:00
[INFO] ------------------------------------------------------------------------

~/readable-file-example

```

上記を動作させるには、Beam側での対応が必要であり、https://github.com/apache/beam/pull/15510 で対応が取り込まれている。

https://github.com/apache/beam/pull/15510 のマージは`Oct 7, 2021`ということなので、`Oct 13, 2021`にリリースされたBeam 2.33.0以降が必要である。

まとめると、更新日時を正しく取得するには以下が必要である。

- Beam 2.33.0以降のBeam
- 以下のワークアラウンドコード
```
MetadataCoderV2 metadataCoder = MetadataCoderV2.of();
p.getCoderRegistry().registerCoderForClass(MatchResult.Metadata.class, metadataCoder);
p.getCoderRegistry().registerCoderForClass(FileIO.ReadableFile.class, ReadableFileCoder.of(metadataCoder));
```
