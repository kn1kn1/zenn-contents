---
title: "Apache Beam Javaã‹ã‚‰RunInferenceã§scikit-learnã®å‡¦ç†ã‚’å‘¼ã³å‡ºã™"
emoji: "ğŸ¥—"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ApacheBeam", "Dataflow", "scikitlearn", "Java", "Python"]
published: true
---

# æ¦‚è¦

Apache Beam Javaã‹ã‚‰Pythonã®å‡¦ç†ã‚’å‘¼ã³å‡ºã™ä¾‹ã«ã¤ã„ã¦ã€ä»¥å‰ã« [Apache Beam Java multi-language pipelines quickstart ãƒ¡ãƒ¢ - zenn](https://zenn.dev/kn1kn1/articles/4aadd3bb4eeb14)ã§è©¦ã—ãŸãŒã€scikit-learnã®å‡¦ç†ã‚’å‘¼ã³å‡ºã™ä¾‹ãŒBeamã®Exampleã«è¿½åŠ ã•ã‚Œã¦ã„ãŸã®ã§è©¦ã—ã¦ã¿ãŸã€‚https://github.com/kn1kn1/beam-example-multi-language-sklern ã«æœ€çµ‚çš„ã«å‹•ä½œã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´ã—ãŸã€‚

# æ‰‹é †

åŸºæœ¬çš„ã«ã¯ã€https://github.com/apache/beam/tree/master/examples/multi-language#sklearn-mnist-classification ã«ã‚ã‚‹ã¨ãŠã‚Šã®æ‰‹é †ã§ã‚ã‚‹ã€‚


Javaã¨Beamã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŒ‡å®šã—ã€`mvn archetype:generate`ã«ã‚ˆã‚Šã€exampleã®mavenãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–°è¦ä½œæˆã™ã‚‹ã€‚

```
~
$ jenv local oracle64-11.0.16.1

~
$ export BEAM_VERSION=2.43.0

~
$ echo $BEAM_VERSION
2.43.0

~
$ mvn archetype:generate \
    -DarchetypeGroupId=org.apache.beam \
    -DarchetypeArtifactId=beam-sdks-java-maven-archetypes-examples \
    -DarchetypeVersion=$BEAM_VERSION \
    -DgroupId=org.example \
    -DartifactId=multi-language-beam \
    -Dversion="0.1" \
    -Dpackage=org.apache.beam.examples \
    -DinteractiveMode=false
[INFO] Scanning for projects...

:
(snip)
:


[INFO] ----------------------------------------------------------------------------
[INFO] Using following parameters for creating project from Archetype: beam-sdks-java-maven-archetypes-examples:2.43.0
[INFO] ----------------------------------------------------------------------------
[INFO] Parameter: groupId, Value: org.example
[INFO] Parameter: artifactId, Value: multi-language-beam
[INFO] Parameter: version, Value: 0.1
[INFO] Parameter: package, Value: org.apache.beam.examples
[INFO] Parameter: packageInPathFormat, Value: org/apache/beam/examples
[INFO] Parameter: package, Value: org.apache.beam.examples
[INFO] Parameter: groupId, Value: org.example
[INFO] Parameter: artifactId, Value: multi-language-beam
[INFO] Parameter: targetPlatform, Value: 1.8
[INFO] Parameter: version, Value: 0.1
[INFO] Project created from Archetype in dir: /multi-language-beam
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  6.224 s
[INFO] Finished at: 2022-11-22T08:11:40+09:00
[INFO] ------------------------------------------------------------------------

~
$ 
```

ä½œã£ãŸmavenãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å…¥ã‚Šã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§Dataflowã‚¸ãƒ§ãƒ–ã‚’ç™»éŒ²ã™ã‚‹ã€‚

```
~
$ cd multi-language-beam 

~/multi-language-beam
$ jenv local oracle64-11.0.16.1

~/multi-language-beam
$ export GCP_PROJECT=<GCP project>
export GCP_BUCKET=<GCP bucket>
export GCP_REGION=<GCP region>

mvn compile exec:java -Dexec.mainClass=org.apache.beam.examples.multilanguage.SklearnMnistClassification \
    -Dexec.args="--runner=DataflowRunner --project=$GCP_PROJECT \
                 --region=$GCP_REGION \
                 --gcpTempLocation=gs://$GCP_BUCKET/multi-language-beam/ \
                 --output=gs://$GCP_BUCKET/multi-language-beam/output" \
    -Pdataflow-runner
[INFO] Scanning for projects...
Downloading from central: https://repo.maven.apache.org/maven2/com/google/cloud/libraries-bom/26.1.3/libraries-bom-26.1.3.pom

:
(snip)
:

[INFO] 95 errors 
[INFO] -------------------------------------------------------------
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  02:13 min
[INFO] Finished at: 2022-11-22T08:17:34+09:00
[INFO] ------------------------------------------------------------------------
[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.7.0:compile (default-compile) on project multi-language-beam: Compilation failure: Compilation failure: 
[ERROR] /multi-language-beam/src/main/java/org/apache/beam/examples/WordCount.java:[18,1] org.apache.beam.examplesã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“

:
(snip)
:

~/multi-language-beam
$ 
```

`WordCount.java`ãªã©ä»Šå›ä½¿ç”¨ãªã„ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ã‚‹ã®ã§ã€ä¸è¦ãªã‚‚ã®ã‚’å‰Šé™¤ã—ãŸã€‚

https://github.com/kn1kn1/beam-example-multi-language-sklern ã«æœ€çµ‚çš„ã«å‹•ä½œã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ ¼ç´ã—ãŸã€‚

ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãŒé€šã‚‹ã‚ˆã†ã«ã—ãŸçŠ¶æ…‹ã§ã€å†åº¦mvnã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚

```
~/multi-language-beam
$ export GCP_PROJECT=<GCP project>
export GCP_BUCKET=<GCP bucket>
export GCP_REGION=<GCP region>

mvn compile exec:java -Dexec.mainClass=org.apache.beam.examples.multilanguage.SklearnMnistClassification \
    -Dexec.args="--runner=DataflowRunner --project=$GCP_PROJECT \
                 --region=$GCP_REGION \
                 --gcpTempLocation=gs://$GCP_BUCKET/multi-language-beam/ \
                 --output=gs://$GCP_BUCKET/multi-language-beam/output" \
    -Pdataflow-runner
[INFO] Scanning for projects...
[INFO] 
[INFO] ------------------< org.example:multi-language-beam >-------------------
[INFO] Building multi-language-beam 0.1
[INFO] --------------------------------[ jar ]---------------------------------
[INFO] 
[INFO] --- maven-resources-plugin:2.6:resources (default-resources) @ multi-language-beam ---
[WARNING] Using platform encoding (UTF-8 actually) to copy filtered resources, i.e. build is platform dependent!
[INFO] skip non existing resourceDirectory /multi-language-beam/src/main/resources
[INFO] 
[INFO] --- maven-compiler-plugin:3.7.0:compile (default-compile) @ multi-language-beam ---
[INFO] Changes detected - recompiling the module!
[WARNING] File encoding has not been set, using platform encoding UTF-8, i.e. build is platform dependent!
[INFO] Compiling 16 source files to /multi-language-beam/target/classes
[INFO] 
[INFO] --- exec-maven-plugin:1.6.0:java (default-cli) @ multi-language-beam ---
11æœˆ 22, 2022 8:19:39 åˆå‰ org.apache.beam.runners.dataflow.options.DataflowPipelineOptions$StagingLocationFactory create
æƒ…å ±: No stagingLocation provided, falling back to gcpTempLocation
11æœˆ 22, 2022 8:19:39 åˆå‰ org.apache.beam.runners.dataflow.DataflowRunner fromOptions
æƒ…å ±: PipelineOptions.filesToStage was not specified. Defaulting to files from the classpath: will stage 257 files. Enable logging at DEBUG level to see which files will be staged.
11æœˆ 22, 2022 8:19:40 åˆå‰ org.apache.beam.sdk.extensions.python.transforms.RunInference inferExtraPackagesFromModelHandler
æƒ…å ±: Automatically inferred dependencies [scikit-learn, pandas] from the provided model handler.
11æœˆ 22, 2022 8:19:40 åˆå‰ org.apache.beam.sdk.extensions.python.PythonService start
æƒ…å ±: Running bootstrap command [python3, /var/folders/3s/6y2ls7zs7txf0wzf1p7ddhq00000gp/T/bootstrap_beam_venv9379698604696593328.py, --beam_version=2.43.0, --extra_packages=scikit-learn;pandas]
11æœˆ 22, 2022 8:19:43 åˆå‰ org.apache.beam.sdk.extensions.python.PythonService start
æƒ…å ±: Requirement already satisfied: pip in ~/.apache_beam/cache/venvs/py-3.9-beam-2.43.0-58fa10bd297d1d33d0540cdb3637e9da88210341/lib/python3.9/site-packages (21.2.3)

:
(snip)
:

11æœˆ 22, 2022 8:36:00 åˆå‰ org.apache.beam.runners.dataflow.DataflowPipelineJob logTerminalState
æƒ…å ±: Job 2022-11-21_15_23_21-10474618917274212526 finished with status DONE.
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
[INFO] Total time:  16:25 min
[INFO] Finished at: 2022-11-22T08:36:00+09:00
[INFO] ------------------------------------------------------------------------

~/multi-language-beam
$ 

```

å‰å›ã¨åŒæ§˜ã«ã€èµ·å‹•ã—ã¦ã‹ã‚‰æœ€åˆã®transformï¼ˆReadLinesã¨æ›¸ã„ã¦ã‚ã‚‹ã‚‚ã®ï¼‰ãŒèµ·å‹•ã™ã‚‹ã¾ã§5åˆ†ä»¥ä¸Šæ›ã‹ã‚‹ã®ã§å¿ƒé…ã«ãªã‚‹ãŒã€ã—ã°ã‚‰ãå¾…ã¤ã€‚

æœ€çµ‚çš„ã«ã¯ã€Dataflowã®ã‚¸ãƒ§ãƒ–ã¨ã—ã¦ã¯12åˆ†å¼·ã€ãƒ“ãƒ«ãƒ‰å…¨ä½“ã¨ã—ã¦ã¯16åˆ†å¼·æ›ã‹ã£ãŸã€‚

# ãã®ä»–æ°—ã«ãªã£ãŸã¨ã“ã‚
- å®Ÿè¡Œã•ã‚Œã‚‹pythonã®ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã¯ã€ä»¥ä¸‹ã®éƒ¨åˆ†ã«å®šç¾©ã•ã‚ŒãŸã‚‚ã®ã®ã‚ˆã†ã§ã‚ã‚‹ã€‚

https://github.com/kn1kn1/beam-example-multi-language-sklern/blob/master/src/main/java/org/apache/beam/examples/multilanguage/SklearnMnistClassification.java#L57-L60

- ã“ã‚Œã‚’`RunInference`ã¨ã„ã†transformã§å®Ÿè¡Œã—ã¦ã„ã‚‹ã€‚

https://github.com/kn1kn1/beam-example-multi-language-sklern/blob/master/src/main/java/org/apache/beam/examples/multilanguage/SklearnMnistClassification.java#L117

- ä»Šå›ã€pythonã‚„Beam Python SDKã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯æ˜ç¤ºçš„ã«ã¯è¡Œã‚ãªã‹ã£ãŸãŒã€ãƒ­ã‚°ã‚’è¦‹ã‚‹ã¨`py-3.9-beam-2.43.0`ã¨å‡ºã¦ãã‚‹ã®ã§ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒå‰æã¨ãªã£ã¦ã„ã‚‹æ¨¡æ§˜ã ã€‚

# è¿½è¨˜

ä¸Šè¨˜ã§ã‚‚å‡ºã¦ãã‚‹Dataflowãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¸ãƒ§ãƒ–ã®ç™»éŒ²ã®mvnã‚³ãƒãƒ³ãƒ‰ã§ã€`GCP_REGION`ç’°å¢ƒå¤‰æ•°ãŒå‚ç…§ã•ã‚Œã¦ãŠã‚‰ãšã€`us-central1`ã‚’æŒ‡å®šã—ãŸçŠ¶æ…‹ã«ãªã£ã¦ã„ãŸã®ã§ã€PRã‚’é€ã£ãŸã¨ã“ã‚ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã€‚

https://github.com/apache/beam/pull/24302
